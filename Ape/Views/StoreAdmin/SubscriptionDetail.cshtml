@model Ape.Models.ViewModels.AdminSubscriptionDetailViewModel

<div class="container-fluid mt-3">

    <h2 class="text-center"><i class="bi bi-arrow-repeat"></i> @Model.ProductName</h2>
    <p class="text-center">
        <span class="badge @Model.StatusBadgeClass fs-6">@Model.Status</span>
    </p>

    <div class="text-center mb-3">
        <a asp-action="Subscriptions" class="btn btn-secondary"><i class="bi bi-arrow-left"></i> Back to Subscriptions</a>
    </div>

    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success">@TempData["SuccessMessage"]</div>
    }
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger">@TempData["ErrorMessage"]</div>
    }

    <div class="row">
        <div class="col-lg-8">

            <!-- Subscription Info -->
            <div class="card mb-3">
                <div class="card-header"><strong>Subscription Details</strong></div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p class="mb-1"><strong>User:</strong> @Model.UserEmail</p>
                            <p class="mb-1"><strong>Plan:</strong> @Model.ProductName</p>
                            @if (!string.IsNullOrEmpty(Model.ProductDescription))
                            {
                                <p class="mb-1 text-muted"><small>@Model.ProductDescription</small></p>
                            }
                            <p class="mb-1"><strong>Amount:</strong> @Model.BillingDisplay</p>
                            <p class="mb-0"><strong>Gateway:</strong> <span class="badge bg-secondary">@Model.PaymentGateway</span></p>
                        </div>
                        <div class="col-md-6">
                            @if (!string.IsNullOrEmpty(Model.StripeSubscriptionId))
                            {
                                <p class="mb-1"><strong>Stripe ID:</strong> <small class="text-muted">@Model.StripeSubscriptionId</small></p>
                            }
                            @if (!string.IsNullOrEmpty(Model.PayPalSubscriptionId))
                            {
                                <p class="mb-1"><strong>PayPal ID:</strong> <small class="text-muted">@Model.PayPalSubscriptionId</small></p>
                            }
                            @if (Model.CurrentPeriodStart.HasValue)
                            {
                                <p class="mb-1"><strong>Period Start:</strong> @Model.CurrentPeriodStart.Value.ToString("MMM dd, yyyy")</p>
                            }
                            @if (Model.CurrentPeriodEnd.HasValue)
                            {
                                <p class="mb-1"><strong>Period End:</strong> @Model.CurrentPeriodEnd.Value.ToString("MMM dd, yyyy")</p>
                            }
                            @if (Model.CancelledDate.HasValue)
                            {
                                <p class="mb-1"><strong>Cancelled:</strong> @Model.CancelledDate.Value.ToString("MMM dd, yyyy")</p>
                            }
                            @if (!string.IsNullOrEmpty(Model.CancelReason))
                            {
                                <p class="mb-0"><strong>Cancel Reason:</strong> @Model.CancelReason</p>
                            }
                        </div>
                    </div>
                </div>
            </div>

            <!-- Payment History -->
            <div class="card mb-3">
                <div class="card-header"><strong><i class="bi bi-credit-card"></i> Payment History</strong></div>
                @if (!Model.Payments.Any())
                {
                    <div class="card-body text-center text-muted py-4">
                        <i class="bi bi-inbox display-6"></i>
                        <p class="mt-2 mb-0">No payment records yet.</p>
                    </div>
                }
                else
                {
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Amount</th>
                                    <th>Gateway</th>
                                    <th>Transaction</th>
                                    <th>Notes</th>
                                    <th>Status</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var payment in Model.Payments)
                                {
                                    <tr>
                                        <td>@payment.PaymentDate.ToString("MMM dd, yyyy h:mm tt")</td>
                                        <td>@payment.Amount.ToString("C")</td>
                                        <td><span class="badge bg-secondary">@payment.PaymentGateway</span></td>
                                        <td><small class="text-muted text-break">@payment.TransactionId</small></td>
                                        <td><small>@payment.Notes</small></td>
                                        <td><span class="badge @payment.StatusBadgeClass">@payment.Status</span></td>
                                        <td>
                                            @if (payment.Status == "Paid")
                                            {
                                                <button type="button"
                                                        class="btn btn-sm btn-outline-danger"
                                                        data-bs-toggle="modal"
                                                        data-bs-target="#refundModal-@payment.PaymentID">
                                                    <i class="bi bi-arrow-counterclockwise"></i> Refund
                                                </button>
                                            }
                                            @if (payment.Status == "Refunded")
                                            {
                                                <small class="text-muted d-block">@payment.RefundedDate?.ToString("MMM dd, yyyy")</small>
                                                @if (!string.IsNullOrEmpty(payment.RefundReason))
                                                {
                                                    <small class="text-muted d-block">@payment.RefundReason</small>
                                                }
                                            }
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
            </div>
        </div>

        <div class="col-lg-4">

            <!-- Summary -->
            <div class="card mb-3">
                <div class="card-header"><strong>Payment Summary</strong></div>
                <div class="card-body">
                    @{
                        var totalPaid = Model.Payments.Where(p => p.Status == "Paid").Sum(p => p.Amount);
                        var totalRefunded = Model.Payments.Where(p => p.Status == "Refunded").Sum(p => p.Amount);
                    }
                    <div class="d-flex justify-content-between mb-1">
                        <span>Total Paid</span>
                        <span class="text-success fw-bold">@totalPaid.ToString("C")</span>
                    </div>
                    <div class="d-flex justify-content-between mb-1">
                        <span>Total Refunded</span>
                        <span class="text-danger fw-bold">@totalRefunded.ToString("C")</span>
                    </div>
                    <hr />
                    <div class="d-flex justify-content-between fw-bold">
                        <span>Net</span>
                        <span>@((totalPaid - totalRefunded).ToString("C"))</span>
                    </div>
                    <p class="text-muted small mt-2 mb-0">@Model.Payments.Count payment(s) recorded</p>
                </div>
            </div>

            <!-- Timeline -->
            <div class="card mb-3">
                <div class="card-header"><strong>Timeline</strong></div>
                <div class="card-body small">
                    <p class="mb-1"><i class="bi bi-calendar-plus"></i> Created: @Model.CreatedDate.ToString("MMM dd, yyyy h:mm tt")</p>
                    @if (Model.CurrentPeriodStart.HasValue)
                    {
                        <p class="mb-1"><i class="bi bi-play-circle"></i> Period Start: @Model.CurrentPeriodStart.Value.ToString("MMM dd, yyyy")</p>
                    }
                    @if (Model.CurrentPeriodEnd.HasValue)
                    {
                        <p class="mb-1"><i class="bi bi-clock"></i> Period End: @Model.CurrentPeriodEnd.Value.ToString("MMM dd, yyyy")</p>
                    }
                    @if (Model.CancelledDate.HasValue)
                    {
                        <p class="mb-1"><i class="bi bi-x-circle"></i> Cancelled: @Model.CancelledDate.Value.ToString("MMM dd, yyyy h:mm tt")</p>
                    }
                    @foreach (var payment in Model.Payments.OrderBy(p => p.PaymentDate))
                    {
                        <p class="mb-1">
                            <i class="bi bi-credit-card"></i> @payment.PaymentDate.ToString("MMM dd, yyyy") &mdash; @payment.Amount.ToString("C") (@payment.Status)
                        </p>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Refund Modals -->
@foreach (var payment in Model.Payments.Where(p => p.Status == "Paid"))
{
    <div class="modal fade" id="refundModal-@payment.PaymentID" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <form asp-action="RefundSubscriptionPayment" method="post">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="paymentId" value="@payment.PaymentID" />
                    <div class="modal-header">
                        <h5 class="modal-title">Refund Payment</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p>Refund <strong>@payment.Amount.ToString("C")</strong> paid on @payment.PaymentDate.ToString("MMM dd, yyyy")?</p>
                        <p class="text-muted small">Transaction: @payment.TransactionId</p>
                        <div class="mb-0">
                            <label class="form-label">Reason (optional)</label>
                            <textarea name="reason" class="form-control" rows="2" maxlength="500"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-danger"><i class="bi bi-arrow-counterclockwise"></i> Confirm Refund</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
}

@section Styles {
    <link rel="stylesheet" href="~/css/store.css" asp-append-version="true" />
}
