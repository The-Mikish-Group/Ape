@model List<Ape.Models.ViewModels.ProductViewModel>
@{
    ViewData["Title"] = ViewData["Title"];
    var filterType = ViewData["FilterType"] as Ape.Models.ProductType?;
    var showInactive = (bool)(ViewData["ShowInactive"] ?? false);
    var searchQuery = ViewData["SearchQuery"] as string;
    var currentPage = (int)(ViewData["CurrentPage"] ?? 1);
    var totalPages = (int)(ViewData["TotalPages"] ?? 1);
    var totalCount = (int)(ViewData["TotalCount"] ?? 0);
}

<div class="container-fluid mt-3">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2><i class="bi bi-box-seam"></i> Products <span class="badge bg-secondary">@totalCount</span></h2>
        <a asp-action="CreateProduct" class="btn btn-success"><i class="bi bi-plus-lg"></i> Add Product</a>
    </div>

    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show">@TempData["SuccessMessage"]<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>
    }
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show">@TempData["ErrorMessage"]<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>
    }

    <!-- Filters -->
    <div class="card mb-3">
        <div class="card-body">
            <form method="get" class="row g-2 align-items-end">
                <div class="col-auto">
                    <label class="form-label small">Type</label>
                    <select name="type" class="form-select form-select-sm" onchange="this.form.submit()">
                        <option value="">All Types</option>
                        <!option value="Physical" @(filterType == Ape.Models.ProductType.Physical ? "selected" : "")>Physical</!option>
                        <!option value="Digital" @(filterType == Ape.Models.ProductType.Digital ? "selected" : "")>Digital</!option>
                        <!option value="Subscription" @(filterType == Ape.Models.ProductType.Subscription ? "selected" : "")>Subscription</!option>
                    </select>
                </div>
                <div class="col-auto">
                    <label class="form-label small">Search</label>
                    <input type="text" name="search" value="@searchQuery" class="form-control form-control-sm" placeholder="Name, SKU..." />
                </div>
                <div class="col-auto">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="showInactive" value="true" id="showInactive"
                               @(showInactive ? "checked" : "") onchange="this.form.submit()" />
                        <label class="form-check-label" for="showInactive">Show Inactive</label>
                    </div>
                </div>
                <div class="col-auto">
                    <button type="submit" class="btn btn-sm btn-outline-primary"><i class="bi bi-search"></i> Filter</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Products Table -->
    <div class="card">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-dark">
                    <tr>
                        <th style="width:60px;">Image</th>
                        <th>Product</th>
                        <th>SKU</th>
                        <th>Type</th>
                        <th>Price</th>
                        <th>Stock</th>
                        <th>Status</th>
                        <th style="width:120px;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @if (!Model.Any())
                    {
                        <tr><td colspan="8" class="text-center py-4 text-muted">No products found.</td></tr>
                    }
                    @foreach (var product in Model)
                    {
                        <tr class="@(!product.IsActive ? "table-secondary" : "")">
                            <td>
                                @if (product.PrimaryThumbnailUrl != null)
                                {
                                    <img src="@product.PrimaryThumbnailUrl" alt="@product.Name" class="rounded" style="width:50px;height:50px;object-fit:cover;" />
                                }
                                else
                                {
                                    <div class="bg-light rounded d-flex align-items-center justify-content-center" style="width:50px;height:50px;">
                                        <i class="bi bi-image text-muted"></i>
                                    </div>
                                }
                            </td>
                            <td>
                                <strong>@product.Name</strong>
                                @if (product.IsFeatured) { <span class="badge bg-warning text-dark ms-1">Featured</span> }
                                @if (!product.IsActive) { <span class="badge bg-secondary ms-1">Inactive</span> }
                            </td>
                            <td><code>@product.SKU</code></td>
                            <td><span class="badge @product.ProductTypeBadgeClass">@product.ProductType</span></td>
                            <td>
                                @product.Price.ToString("C")
                                @if (product.MemberPrice.HasValue)
                                {
                                    <br /><small class="text-success">Member: @product.MemberPrice.Value.ToString("C")</small>
                                }
                            </td>
                            <td>
                                @if (product.ProductType == Ape.Models.ProductType.Physical)
                                {
                                    if (product.TrackInventory)
                                    {
                                        <span class="@(product.IsLowStock ? "text-warning fw-bold" : product.StockQuantity == 0 ? "text-danger fw-bold" : "")">
                                            @product.StockQuantity
                                        </span>
                                    }
                                    else
                                    {
                                        <span class="text-muted">N/A</span>
                                    }
                                }
                                else
                                {
                                    <span class="text-muted">-</span>
                                }
                            </td>
                            <td>
                                @if (product.IsActive)
                                {
                                    <span class="badge bg-success">Active</span>
                                }
                                else
                                {
                                    <span class="badge bg-secondary">Inactive</span>
                                }
                            </td>
                            <td>
                                <a asp-action="EditProduct" asp-route-id="@product.ProductId" class="btn btn-sm btn-outline-primary" title="Edit">
                                    <i class="bi bi-pencil"></i>
                                </a>
                                <form asp-action="DeleteProduct" method="post" class="d-inline" onsubmit="return confirm('Deactivate this product?');">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="id" value="@product.ProductId" />
                                    <button type="submit" class="btn btn-sm btn-outline-danger" title="Deactivate"><i class="bi bi-trash"></i></button>
                                </form>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>

    <!-- Pagination -->
    @if (totalPages > 1)
    {
        <nav class="mt-3">
            <ul class="pagination justify-content-center">
                @for (var i = 1; i <= totalPages; i++)
                {
                    <li class="page-item @(i == currentPage ? "active" : "")">
                        <a class="page-link" asp-action="Products" asp-route-page="@i" asp-route-type="@filterType"
                           asp-route-showInactive="@showInactive" asp-route-search="@searchQuery">@i</a>
                    </li>
                }
            </ul>
        </nav>
    }
</div>
