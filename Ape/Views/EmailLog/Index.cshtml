@using Ape.Models
@{
    ViewData["Title"] = "Email Send Log";
    var emailLogs = ViewBag.EmailLogs as List<EmailLog> ?? new List<EmailLog>();
    var serverStats = ViewBag.ServerStats as List<dynamic> ?? new List<dynamic>();
    var currentPage = (int)(ViewBag.CurrentPage ?? 1);
    var totalPages = (int)(ViewBag.TotalPages ?? 1);
    var totalCount = (int)(ViewBag.TotalCount ?? 0);
    var search = ViewBag.Search as string ?? "";
    var serverFilter = ViewBag.ServerFilter as string ?? "All";
}

<!-- Row 1: Title - centered with mt-4 spacing from header -->
<div class="text-center mt-4">
    <h2>Email Send Log</h2>
</div>

<!-- Row 2: Description - centered -->
<div class="text-center">
    <p>Persistent email logging with search and filtering &bull; Total: @totalCount emails logged</p>
</div>

<!-- Row 3: Navigation/Action Buttons - centered -->
<div class="text-center mb-3">
    <a asp-controller="Info" asp-action="Index" class="btn btn-secondary me-2">Back to Home</a>
    <a asp-controller="EmailTest" asp-action="Index" class="btn btn-primary">Test Email System</a>
</div>

<!-- Main content starts after the standard heading -->
<div class="container">

<!-- Status Messages -->
@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @TempData["SuccessMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

@if (TempData["InfoMessage"] != null)
{
    <div class="alert alert-info alert-dismissible fade show" role="alert">
        @TempData["InfoMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        @TempData["ErrorMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<!-- Server Statistics -->
<div class="row mb-3">
    @foreach (var stat in serverStats)
    {
        <div class="col-md-3">
            <div class="card">
                <div class="card-body text-center">
                    <h5 class="card-title">
                        @if (stat.Server == "Azure")
                        {
                            <span class="text-info">Azure</span>
                        }
                        else if (stat.Server == "SMTP")
                        {
                            <span class="text-warning">SMTP</span>
                        }
                        else
                        {
                            <span class="text-muted">@stat.Server</span>
                        }
                    </h5>
                    <p class="card-text"><strong>@stat.Count</strong> emails</p>
                </div>
            </div>
        </div>
    }
</div>

<!-- Search and Filter Form -->
<form method="get" class="mb-4">
    <div class="row">
        <div class="col-md-4">
            <div class="form-floating">
                <input type="text" class="form-control" id="search" name="search" value="@search"
                       placeholder="Search emails..." onkeyup="liveSearch()">
                <label for="search">Search emails (live)</label>
            </div>
        </div>
        <div class="col-md-3">
            <div class="form-floating">
                <select class="form-select" id="serverFilter" name="serverFilter" onchange="this.form.submit()">
                    <!option value="All" @(serverFilter == "All" ? "selected" : "")>All Servers</!option>
                    <!option value="Azure" @(serverFilter == "Azure" ? "selected" : "")>Azure</!option>
                    <!option value="SMTP" @(serverFilter == "SMTP" ? "selected" : "")>SMTP</!option>
                    <!option value="Unknown" @(serverFilter == "Unknown" ? "selected" : "")>Unknown</!option>
                </select>
                <label for="serverFilter">Filter by Server</label>
            </div>
        </div>
        <div class="col-md-3">
            <button type="submit" class="btn btn-primary btn-lg">Search</button>
            <a href="/EmailLog" class="btn btn-outline-secondary btn-lg">Clear</a>
        </div>
        <div class="col-md-2">
            <button type="button" class="btn btn-warning btn-lg" data-bs-toggle="modal" data-bs-target="#cleanupModal">
                Cleanup
            </button>
        </div>
    </div>
</form>

<!-- Results Table -->
<div class="table-responsive">
    <table class="table table-striped table-hover" id="emailTable">
        <thead class="table-dark">
            <tr>
                <th>Timestamp</th>
                <th>To</th>
                <th>Subject</th>
                <th>Status</th>
                <th>Server</th>
                <th>Type</th>
                <th>Sent By</th>
                <th>Details</th>
            </tr>
        </thead>
        <tbody>
            @if (!emailLogs.Any())
            {
                <tr>
                    <td colspan="8" class="text-center py-4">
                        @if (!string.IsNullOrWhiteSpace(search))
                        {
                            <span>No email logs found matching "@search"</span>
                        }
                        else
                        {
                            <span>No email logs found. Send some emails to see them here!</span>
                        }
                    </td>
                </tr>
            }
            else
            {
                @foreach (var log in emailLogs)
                {
                    <tr>
                        <td>
                            <small>@log.Timestamp.ToString("MM/dd/yyyy")</small><br>
                            <small class="text-muted">@log.Timestamp.ToString("HH:mm:ss")</small>
                        </td>
                        <td>
                            <span class="text-truncate" style="max-width: 150px; display: inline-block;" title="@log.ToEmail">
                                @log.ToEmail
                            </span>
                        </td>
                        <td>
                            <span class="text-truncate" style="max-width: 200px; display: inline-block;" title="@log.Subject">
                                @log.Subject
                            </span>
                        </td>
                        <td>
                            @if (log.Success)
                            {
                                <span class="badge bg-success">Sent</span>
                            }
                            else
                            {
                                <span class="badge bg-danger">Failed</span>
                            }
                            @if (log.RetryCount > 0)
                            {
                                <br><small class="text-warning">Retry: @log.RetryCount</small>
                            }
                        </td>
                        <td>
                            @if (log.EmailServer == "Azure")
                            {
                                <span class="badge bg-info">Azure</span>
                            }
                            else if (log.EmailServer == "SMTP")
                            {
                                <span class="badge bg-warning">SMTP</span>
                            }
                            else
                            {
                                <span class="badge bg-secondary">@log.EmailServer</span>
                            }
                        </td>
                        <td>
                            @if (!string.IsNullOrEmpty(log.EmailType))
                            {
                                <span class="badge bg-light text-dark">@log.EmailType</span>
                            }
                        </td>
                        <td>
                            <small>@(log.SentBy ?? "System")</small>
                        </td>
                        <td>
                            <span class="text-truncate" style="max-width: 300px; display: inline-block;" title="@log.Details">
                                @log.Details
                            </span>
                            @if (!string.IsNullOrEmpty(log.MessageId))
                            {
                                <br><small class="text-muted">ID: @log.MessageId</small>
                            }
                        </td>
                    </tr>
                }
            }
        </tbody>
    </table>
</div>

<!-- Pagination -->
@if (totalPages > 1)
{
    <nav aria-label="Email log pagination">
        <ul class="pagination justify-content-center">
            <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                <a class="page-link" href="?page=@(currentPage - 1)&search=@search&serverFilter=@serverFilter">Previous</a>
            </li>

            @for (int i = Math.Max(1, currentPage - 2); i <= Math.Min(totalPages, currentPage + 2); i++)
            {
                <li class="page-item @(i == currentPage ? "active" : "")">
                    <a class="page-link" href="?page=@i&search=@search&serverFilter=@serverFilter">@i</a>
                </li>
            }

            <li class="page-item @(currentPage == totalPages ? "disabled" : "")">
                <a class="page-link" href="?page=@(currentPage + 1)&search=@search&serverFilter=@serverFilter">Next</a>
            </li>
        </ul>
    </nav>

    <div class="text-center">
        <small class="text-muted">
            Page @currentPage of @totalPages &bull; Showing @emailLogs.Count of @totalCount total emails
        </small>
    </div>
}

<!-- Action Buttons -->
<div class="mt-4 mb-4 text-center">
    <a href="/EmailTest" class="btn btn-primary btn-lg">Test Email System</a>
    <a href="/EmailLog" class="btn btn-secondary btn-lg">Refresh</a>
</div>

</div> <!-- End container -->

<!-- Cleanup Confirmation Modal -->
<div class="modal fade" id="cleanupModal" tabindex="-1" aria-labelledby="cleanupModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="cleanupModalLabel">Clear Old Email Logs</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="mb-3">Choose how far back you want to delete email logs:</p>

                <!-- Quick Preset Buttons -->
                <div class="row mb-4">
                    <div class="col-12">
                        <h6 class="mb-2">Quick Presets:</h6>
                        <div class="btn-group w-100 mb-2" role="group">
                            <button type="button" class="btn btn-outline-warning" onclick="setCleanupDate(7, this)">
                                7 Days
                            </button>
                            <button type="button" class="btn btn-outline-warning" onclick="setCleanupDate(30, this)">
                                30 Days
                            </button>
                            <button type="button" class="btn btn-outline-warning" onclick="setCleanupDate(60, this)">
                                60 Days
                            </button>
                            <button type="button" class="btn btn-outline-warning" onclick="setCleanupDate(90, this)">
                                90 Days
                            </button>
                            <button type="button" class="btn btn-outline-warning" onclick="setCleanupDate(180, this)">
                                6 Months
                            </button>
                        </div>
                        <button type="button" class="btn btn-warning w-100" onclick="setCleanupDateToToday()">
                            Delete All Logs
                        </button>
                        <small class="text-muted d-block mt-1">Deletes all email logs from the system</small>
                    </div>
                </div>

                <!-- Custom Date Picker -->
                <div class="row mb-3">
                    <div class="col-12">
                        <label class="form-label">Or Choose a Specific Date:</label>
                        <input type="text"
                               class="form-control"
                               id="cleanupDate"
                               name="cleanupDate"
                               placeholder="mm/dd/yyyy"
                               readonly
                               autocomplete="off">
                        <small class="text-muted d-block mt-1">Select any date - logs before this date will be permanently deleted</small>
                        <div id="selectedDatePreview" class="alert alert-success mt-2" style="display: none;">
                            <strong>Selected Date:</strong> <span id="selectedDateText"></span>
                        </div>
                    </div>
                </div>

                <!-- Preview Information -->
                <div class="alert alert-info mb-3">
                    <strong>Current Status:</strong>
                    <ul class="mb-0 mt-2">
                        <li>Total email logs: <strong>@totalCount</strong></li>
                        <li>Oldest log: <strong id="oldestLogDate">Calculating...</strong></li>
                    </ul>
                </div>

                <!-- Warning -->
                <div class="alert alert-warning mb-0">
                    <strong>Warning - This will permanently remove:</strong>
                    <ul class="mb-0 mt-2">
                        <li>All email logs from before the selected date</li>
                        <li>Both successful and failed email records</li>
                        <li>Search history and details</li>
                    </ul>
                    <p class="mt-2 mb-0"><strong>This action cannot be undone.</strong></p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form method="post" asp-action="ClearLogsByDate" id="cleanupForm" style="display: inline;">
                    <input type="hidden" name="cutoffDate" id="cutoffDateInput">
                    <button type="submit" class="btn btn-warning" id="confirmCleanupBtn" disabled>
                        Delete Old Logs
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <!-- jQuery UI for DatePicker -->
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/ui-lightness/jquery-ui.css">
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>

    <script>
        let searchTimeout;

        function liveSearch() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(function() {
                const searchValue = document.getElementById('search').value;
                const currentUrl = new URL(window.location);
                currentUrl.searchParams.set('search', searchValue);
                currentUrl.searchParams.set('page', '1');
                window.location.href = currentUrl.toString();
            }, 500);
        }

        function initializeCleanupDatePicker() {
            $('#cleanupDate').datepicker({
                dateFormat: 'mm/dd/yy',
                changeMonth: true,
                changeYear: true,
                yearRange: '2020:2030',
                showButtonPanel: true,
                onSelect: function(dateText, inst) {
                    updateHiddenDate(dateText);
                },
                onClose: function(dateText, inst) {
                    if (dateText) {
                        updateHiddenDate(dateText);
                    }
                }
            });
        }

        function updateHiddenDate(dateText) {
            if (!dateText) return;

            var parts = dateText.split('/');
            if (parts.length === 3) {
                var month = parts[0].padStart(2, '0');
                var day = parts[1].padStart(2, '0');
                var year = parts[2];

                if (year.length === 2) {
                    year = '20' + year;
                }

                var serverFormat = year + '-' + month + '-' + day;

                $('#cutoffDateInput').val(serverFormat);
                $('#confirmCleanupBtn').prop('disabled', false);

                $('#selectedDateText').text(dateText);
                $('#selectedDatePreview').show();

                $('.btn-group .btn').removeClass('active');
            }
        }

        function setCleanupDate(daysBack, element) {
            var date = new Date();
            date.setDate(date.getDate() - daysBack);

            var month = String(date.getMonth() + 1).padStart(2, '0');
            var day = String(date.getDate()).padStart(2, '0');
            var year = date.getFullYear();
            var displayDate = month + '/' + day + '/' + year;
            var serverFormat = year + '-' + month + '-' + day;

            // Set form data first to ensure it's always populated
            $('#cutoffDateInput').val(serverFormat);
            $('#confirmCleanupBtn').prop('disabled', false);
            $('#selectedDateText').text(displayDate);
            $('#selectedDatePreview').show();
            $('.btn-group .btn').removeClass('active');
            $(element).addClass('active');

            // Update datepicker display (non-critical)
            try {
                $('#cleanupDate').val(displayDate);
                $('#cleanupDate').datepicker('setDate', date);
            } catch (e) { /* datepicker display is cosmetic */ }
        }

        function setCleanupDateToToday() {
            var date = new Date();
            date.setDate(date.getDate() + 1);

            var month = String(date.getMonth() + 1).padStart(2, '0');
            var day = String(date.getDate()).padStart(2, '0');
            var year = date.getFullYear();
            var displayDate = month + '/' + day + '/' + year;
            var serverFormat = year + '-' + month + '-' + day;

            // Set form data first to ensure it's always populated
            $('#cutoffDateInput').val(serverFormat);
            $('#confirmCleanupBtn').prop('disabled', false);
            $('#selectedDateText').text(displayDate + ' (Delete All)');
            $('#selectedDatePreview').show();
            $('.btn-group .btn').removeClass('active');

            // Update datepicker display (non-critical)
            try {
                $('#cleanupDate').val(displayDate);
                $('#cleanupDate').datepicker('setDate', date);
            } catch (e) { /* datepicker display is cosmetic */ }
        }

        $(document).ready(function() {
            initializeCleanupDatePicker();

            $('#cleanupForm').on('submit', function(e) {
                var cutoffDate = $('#cutoffDateInput').val();
                if (!cutoffDate) {
                    e.preventDefault();
                    alert('No date selected. Please select a date first.');
                    return false;
                }
            });

            var cleanupModal = document.getElementById('cleanupModal');
            if (cleanupModal) {
                cleanupModal.addEventListener('show.bs.modal', function() {
                    $('#cleanupDate').val('');
                    $('#cutoffDateInput').val('');
                    $('#confirmCleanupBtn').prop('disabled', true);
                    $('#selectedDatePreview').hide();
                    $('.btn-group .btn').removeClass('active');

                    fetch('/EmailLog/GetOldestLogDate')
                        .then(response => response.json())
                        .then(data => {
                            if (data.oldestDate) {
                                var oldDate = new Date(data.oldestDate);
                                document.getElementById('oldestLogDate').textContent = oldDate.toLocaleDateString();
                            } else {
                                document.getElementById('oldestLogDate').textContent = 'No logs found';
                            }
                        })
                        .catch(function() {
                            document.getElementById('oldestLogDate').textContent = 'Unable to fetch';
                        });
                });
            }
        });

        @if (currentPage == 1 && string.IsNullOrWhiteSpace(search) && serverFilter == "All")
        {
            <text>
            var autoRefreshTimer = setTimeout(function() {
                location.reload();
            }, 30000);

            // Pause auto-refresh while cleanup modal is open
            var cleanupModalEl = document.getElementById('cleanupModal');
            if (cleanupModalEl) {
                cleanupModalEl.addEventListener('show.bs.modal', function() {
                    clearTimeout(autoRefreshTimer);
                });
                cleanupModalEl.addEventListener('hidden.bs.modal', function() {
                    autoRefreshTimer = setTimeout(function() {
                        location.reload();
                    }, 30000);
                });
            }
            </text>
        }
    </script>
}
