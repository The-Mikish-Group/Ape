@inject Ape.Services.SecureConfigurationService ConfigService
@{
    ViewData["Title"] = "Contact Us";
    string siteName = await ConfigService.GetCredentialAsync("SITE_NAME") ?? "Ape";
}

<style>

    .body {
        background-color: white;
    }       

</style>

<div class="my-4 m-0 p-0">
    <div class="row justify-content-center m-1 p-0">
        <div class="col-md-8 col-lg-6 m-0 p-0">

            <div class="card-header bg-gray rounded p-2 shadow">

                <div class="mb-1 p-0 text-center">
                    <h2 class="pb-2">Contact Us</h2>
                    <p class="text-black fw-bold">Fill in the form below to send us an email.</p>
                </div>

                @if (TempData["SuccessMessage"] != null)
                {
                    <div class="alert alert-success">@TempData["SuccessMessage"]</div>
                }

                @if (TempData["ErrorMessage"] != null)
                {
                    <div class="alert alert-danger">@TempData["ErrorMessage"]</div>
                }

                <!-- Contact Form -->
                <form action="@Url.Action("SendEmail", "Info")" method="post" class="needs-validation" novalidate>

                    <!-- fullName -->
                    <div class="form-floating mb-3">
                        <input type="text" class="form-control" id="fullName" name="Name" required>
                        <label for="fullName" class="fw-bold">Your Full Name</label>
                        <div class="invalid-feedback">Please enter your full name.</div>
                    </div>

                    <!-- Email -->
                    <div class="form-floating mb-3">
                        <input type="email" class="form-control" id="email" name="Email" required>
                        <label for="email" class="fw-bold">Your Email</label>
                        <div class="invalid-feedback">Please enter a valid email address.</div>
                    </div>

                    <!-- Subject -->
                    <div class="form-floating mb-3">
                        <input type="text" class="form-control" id="subject" name="Subject" required>
                        <label for="subject" class="fw-bold">Subject</label>
                        <div class="invalid-feedback">Please enter a subject.</div>
                    </div>

                    <!-- Message -->
                    <div class="form-floating mb-3">
                        <textarea class="form-control" id="message" name="Message" rows="12" style="resize: vertical; min-height: 150px;" required></textarea>
                        <label for="message" class="fw-bold">Message</label>
                        <div class="invalid-feedback">Please enter your message.</div>
                    </div>

                    <!-- Phone Number -->
                    <div class="form-floating mb-3">
                        <input type="text" class="form-control" id="phoneNumber" name="Phone Number (Opt.)">
                        <label for="phoneNumber" class="fw-bold">Phone Number (Opt.)</label>
                    </div>

                    <!-- Anti-spam: Form load timestamp (hidden) -->
                    <input type="hidden" id="formLoadTime" name="FormLoadTime" value="">

                    <!-- Anti-spam: JavaScript challenge token (hidden) -->
                    <input type="hidden" id="jsToken" name="JsToken" value="">

                    <!-- Enhanced Honeypot Fields - Bots fill these, humans don't see them -->
                    <div style="position: absolute; left: -9999px;" aria-hidden="true">
                        <label>Comment</label>
                        <textarea name="Comment" rows="1" cols="1" tabindex="-1" autocomplete="off"></textarea>
                        <label>Website</label>
                        <input type="text" name="Website" tabindex="-1" autocomplete="off">
                        <label>Company</label>
                        <input type="text" name="Company" tabindex="-1" autocomplete="off">
                        <label>URL</label>
                        <input type="url" name="Url" tabindex="-1" autocomplete="off">
                    </div>

                    <!-- Send or Cancel -->
                    <div class="d-flex justify-content-between">
                        <a href="~/" class="btn btn-sm btn-secondary rounded-2 me-2 shadow" title="Discard Changes and Return Home">
                            <i class="bi bi-box-arrow-left"></i> Cancel
                        </a>
                        <button type="reset" class="btn btn-sm btn-danger rounded-2 me-2 shadow">
                            <i class="bi bi-arrow-clockwise"></i> Reset
                        </button>
                        <button type="submit" class="btn btn-sm btn-success rounded-2 shadow">
                            <i class="bi bi-check-lg"></i> Send
                        </button>
                    </div>
                </form>

                <!-- Contact Card -->
                <div class="text-black my-4">
                    <div class="card rounded-2 mx-auto rounded p-3 shadow" style="max-width: 350px;">
                        <div class="d-flex flex-column">
                            <div class="mb-3 fs-2 text-center">
                                <strong>@siteName</strong>
                            </div>
                            <div class="mb-1 text-center">
                                <img style="height: 60px;" src="~/images/site/logo.png" />
                                <strong>Message us today!</strong>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Anti-spam: Set form load timestamp and generate JS token when page loads
        (function() {
            document.addEventListener('DOMContentLoaded', function() {
                var loadTimeField = document.getElementById('formLoadTime');
                if (loadTimeField) {
                    loadTimeField.value = new Date().getTime().toString();
                }

                var jsTokenField = document.getElementById('jsToken');
                if (jsTokenField) {
                    var timestamp = new Date().getTime();
                    var random = Math.random().toString(36).substring(2, 15);
                    var token = btoa(timestamp + '-' + random);
                    jsTokenField.value = token;
                }
            });
        })();

        // Bootstrap form validation
        (function () {
            'use strict';
            var forms = document.querySelectorAll('.needs-validation');
            Array.prototype.slice.call(forms).forEach(function (form) {
                form.addEventListener('submit', function (event) {
                    if (!form.checkValidity()) {
                        event.preventDefault();
                        event.stopPropagation();
                    }
                    form.classList.add('was-validated');
                }, false);
            });
        })();

        // Phone number formatting and name capitalization
        document.addEventListener('DOMContentLoaded', function () {
            const phoneNumberInput = document.getElementById('phoneNumber');
            const fullNameInput = document.getElementById('fullName');

            if (phoneNumberInput) {
                phoneNumberInput.addEventListener('input', function () {
                    let inputValue = this.value.replace(/\D/g, '');
                    if (inputValue.length > 10) {
                        inputValue = inputValue.substring(0, 10);
                    }
                    if (inputValue.length > 0) {
                        let formattedValue = '';
                        if (inputValue.length > 0 && inputValue.length < 4) {
                            formattedValue = inputValue;
                        } else if (inputValue.length > 3 && inputValue.length < 7) {
                            formattedValue = '(' + inputValue.substring(0, 3) + ') ' + inputValue.substring(3, 6);
                        } else if (inputValue.length > 6) {
                            formattedValue = '(' + inputValue.substring(0, 3) + ') ' + inputValue.substring(3, 6) + '-' + inputValue.substring(6, 10);
                        }
                        this.value = formattedValue;
                    }
                });
            }

            if (fullNameInput) {
                fullNameInput.addEventListener('input', function () {
                    let inputValue = this.value;
                    let words = inputValue.split(' ');
                    let capitalizedWords = words.map(word => {
                        if (word.length > 0) {
                            return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
                        }
                        return word;
                    });
                    this.value = capitalizedWords.join(' ');
                });
            }
        });
    </script>
}
