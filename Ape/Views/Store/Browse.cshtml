@model Ape.Models.ViewModels.StoreBrowseViewModel

<div class="container-fluid mt-3">
    <!-- Breadcrumbs -->
    <partial name="_StoreBreadcrumbs" model="Model.Breadcrumbs" />

    <div class="row">
        <!-- Sidebar -->
        <div class="col-md-3 col-lg-2">
            <partial name="_CategorySidebar" model="Model.CategoryTree" />

            <!-- Product Type Filter -->
            <div class="card mb-3">
                <div class="card-header py-2"><strong>Product Type</strong></div>
                <div class="list-group list-group-flush">
                    <a asp-action="Browse" asp-route-category="@Model.CurrentCategorySlug" asp-route-sort="@Model.SortBy"
                       class="list-group-item list-group-item-action @(Model.FilterProductType == null ? "active" : "")">All</a>
                    <a asp-action="Browse" asp-route-category="@Model.CurrentCategorySlug" asp-route-type="Physical" asp-route-sort="@Model.SortBy"
                       class="list-group-item list-group-item-action @(Model.FilterProductType == Ape.Models.ProductType.Physical ? "active" : "")">
                        <i class="bi bi-box-seam"></i> Physical
                    </a>
                    <a asp-action="Browse" asp-route-category="@Model.CurrentCategorySlug" asp-route-type="Digital" asp-route-sort="@Model.SortBy"
                       class="list-group-item list-group-item-action @(Model.FilterProductType == Ape.Models.ProductType.Digital ? "active" : "")">
                        <i class="bi bi-file-earmark-arrow-down"></i> Digital
                    </a>
                    <a asp-action="Browse" asp-route-category="@Model.CurrentCategorySlug" asp-route-type="Subscription" asp-route-sort="@Model.SortBy"
                       class="list-group-item list-group-item-action @(Model.FilterProductType == Ape.Models.ProductType.Subscription ? "active" : "")">
                        <i class="bi bi-arrow-repeat"></i> Subscription
                    </a>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="col-md-9 col-lg-10">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <h2>@Model.CurrentCategoryName</h2>
                    @if (Model.CurrentCategoryDescription != null)
                    {
                        <p class="text-muted mb-0">@Model.CurrentCategoryDescription</p>
                    }
                    <small class="text-muted">@Model.TotalProducts product(s)</small>
                </div>
                <div class="d-flex gap-2">
                    <!-- Search -->
                    <form asp-action="Search" method="get" class="d-flex">
                        <input type="text" name="q" value="@Model.SearchQuery" class="form-control form-control-sm" placeholder="Search..." style="width:180px;" />
                        <button type="submit" class="btn btn-sm btn-outline-secondary ms-1"><i class="bi bi-search"></i></button>
                    </form>
                    <!-- Sort -->
                    <select class="form-select form-select-sm" style="width:150px;" onchange="location.href=this.value">
                        <option value="@Url.Action("Browse", new { category = Model.CurrentCategorySlug, type = Model.FilterProductType, sort = "name", search = Model.SearchQuery })" selected="@(Model.SortBy == "name" ? "selected" : null)">Name</option>
                        <option value="@Url.Action("Browse", new { category = Model.CurrentCategorySlug, type = Model.FilterProductType, sort = "price_asc", search = Model.SearchQuery })" selected="@(Model.SortBy == "price_asc" ? "selected" : null)">Price: Low to High</option>
                        <option value="@Url.Action("Browse", new { category = Model.CurrentCategorySlug, type = Model.FilterProductType, sort = "price_desc", search = Model.SearchQuery })" selected="@(Model.SortBy == "price_desc" ? "selected" : null)">Price: High to Low</option>
                        <option value="@Url.Action("Browse", new { category = Model.CurrentCategorySlug, type = Model.FilterProductType, sort = "newest", search = Model.SearchQuery })" selected="@(Model.SortBy == "newest" ? "selected" : null)">Newest</option>
                    </select>
                </div>
            </div>

            <!-- Subcategories -->
            @if (Model.Categories.Any())
            {
                <div class="row g-2 mb-3">
                    @foreach (var cat in Model.Categories)
                    {
                        <div class="col-auto">
                            <a asp-action="Browse" asp-route-category="@cat.Slug" class="btn btn-outline-secondary btn-sm">
                                <i class="bi bi-folder"></i> @cat.Name <span class="badge bg-secondary">@cat.ProductCount</span>
                            </a>
                        </div>
                    }
                </div>
            }

            @if (Model.SearchQuery != null)
            {
                <div class="alert alert-info">
                    Search results for "<strong>@Model.SearchQuery</strong>" â€” @Model.TotalProducts result(s)
                    <a asp-action="Browse" class="ms-2">Clear Search</a>
                </div>
            }

            <!-- Products Grid -->
            @if (Model.Products.Any())
            {
                <div class="row g-3">
                    @foreach (var product in Model.Products)
                    {
                        <div class="col-6 col-md-4 col-lg-3">
                            <partial name="_ProductCard" model="product" />
                        </div>
                    }
                </div>

                <!-- Pagination -->
                @if (Model.TotalPages > 1)
                {
                    <nav class="mt-4">
                        <ul class="pagination justify-content-center">
                            @for (var i = 1; i <= Model.TotalPages; i++)
                            {
                                <li class="page-item @(i == Model.CurrentPage ? "active" : "")">
                                    <a class="page-link" asp-action="Browse" asp-route-category="@Model.CurrentCategorySlug"
                                       asp-route-type="@Model.FilterProductType" asp-route-sort="@Model.SortBy"
                                       asp-route-search="@Model.SearchQuery" asp-route-page="@i">@i</a>
                                </li>
                            }
                        </ul>
                    </nav>
                }
            }
            else
            {
                <div class="text-center py-5 text-muted">
                    <i class="bi bi-inbox display-1"></i>
                    <p class="mt-3">No products found.</p>
                </div>
            }
        </div>
    </div>
</div>

@section Styles {
    <link rel="stylesheet" href="~/css/store.css" asp-append-version="true" />
}
