@page
@model RegisterModel
@inject Ape.Services.SecureConfigurationService ConfigService
@{
    string siteURL = await ConfigService.GetCredentialAsync("SITE_URL") ?? "";
    string siteName = await ConfigService.GetCredentialAsync("SITE_NAME") ?? "Ape";

    ViewData["Title"] = "Register";

    ViewData["Description"] = "Discover the beautiful community of " + siteName + ".";
    ViewData["Canonical"] = siteURL + "/Identity/Account/Register";
    ViewData["OGTitle"] = ViewData["Title"];
    ViewData["OGDescription"] = siteName + " " + ViewData["Title"];
    ViewData["OGURL"] = ViewData["Canonical"];
}

<head>
    <title>@ViewData["Title"]</title>
</head>

<!-- Container -->
<div class="my-4 m-0 p-0">
    <div class="row justify-content-center m-1 p-0">
        <div class="col-md-8 col-lg-6 m-0 p-0">           

            <div class="card bg-gray rounded p-2 shadow">
                <form id="registerForm" asp-route-returnUrl="@Model.ReturnUrl" method="post">

                    <!-- Title -->
                    <h2 class="text-black mb-4 text-center">
                        <i class="bi bi-person-plus"></i> Create your account
                    </h2>

                    <!-- Buttons -->
                    <div class="row justify-content-center mb-2">

                        <div class="col-6 text-center">

                            <!-- Cancel Button -->
                            <a asp-controller="Info" asp-action="Index" class="btn btn-sm btn-secondary rounded-2 me-2 shadow" title="Cancel Registration">
                                ‚¨ÖÔ∏è Cancel
                            </a>
                        </div>

                        <div class="col-6 text-center">

                            <!-- Register -->
                            <button id="registerSubmit" type="submit" class="btn btn-sm btn-primary rounded-2 me-2 shadow">
                                üßç Register
                            </button>
                        </div>

                    </div>

                    <!-- First Middle and Last Name row -->
                    <div class="row gx-1 mb-3">

                        <!-- First Name -->
                        <div class="col-6 form-floating">
                            <input asp-for="Input.FirstName" class="form-control" placeholder="" />
                            <label asp-for="Input.FirstName" class="form-label">First Name</label>
                            <span asp-validation-for="Input.FirstName" class="text-danger"></span>
                        </div>

                        <!-- Middle name -->
                        @*  <div class="col-2 form-floating mb-2">
                            <input asp-for="Input.MiddleName" class="form-control" placeholder="Middle" />
                            <!-- <label asp-for="Input.MiddleName" class="form-label"></label> -->
                            <span asp-validation-for="Input.MiddleName" class="text-danger"></span>
                        </div> *@

                        <!-- Last Name -->
                        <div class="col-6 form-floating">
                            <input asp-for="Input.LastName" class="form-control" placeholder="" />
                            <label asp-for="Input.LastName" class="form-label">Last Name</label>
                            <span asp-validation-for="Input.LastName" class="text-danger"></span>
                        </div>
                    </div>

                    <!-- Email Field -->
                    <div asp-validation-summary="ModelOnly" class="text-danger mb-3 text-center" role="alert"></div>
                    <div class="form-floating mb-3">
                        <input asp-for="Input.Email" class="form-control" autocomplete="username" aria-required="true" placeholder="" />
                        <label asp-for="Input.Email" class="form-label">Email</label>
                        <span asp-validation-for="Input.Email" class="text-danger"></span>
                    </div>

                    <!-- Phone Row -->
                    <div class="row gx-1">

                        <!-- Cell Phone -->
                        <div class="col-12 form-floating mb-3">
                            <input asp-for="Input.PhoneNumber" class="form-control" id="phoneNumber" placeholder="" />
                            <label asp-for="Input.PhoneNumber" class="form-label">Cell Phone</label>
                            <span asp-validation-for="Input.PhoneNumber" class="text-danger"></span>
                        </div>                       

                    </div>

                    <hr />                  

                    <!-- Password -->
                    <div class="form-floating mb-3">
                        <input asp-for="Input.Password" class="form-control" autocomplete="new-password" aria-required="true" placeholder="" />
                        <label asp-for="Input.Password" class="form-label">Password</label>
                        <span asp-validation-for="Input.Password" class="text-danger"></span>
                    </div>

                    <!-- Password Confirm -->
                    <div class="form-floating mb-3">
                        <input asp-for="Input.ConfirmPassword" class="form-control" autocomplete="new-password" aria-required="true" placeholder="" />
                        <label asp-for="Input.ConfirmPassword" class="form-label">Confirm Password</label>
                        <span asp-validation-for="Input.ConfirmPassword" class="text-danger"></span>
                    </div>                    

                </form>               
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const phoneNumberInput = document.getElementById('phoneNumber');
            const homephoneNumberInput = document.getElementById('homephoneNumber');

            // Get references to the input fields for capitalization
            const firstNameInput = document.getElementById('Input_FirstName'); // Replace with actual ID if different
            const middleNameInput = document.getElementById('Input_MiddleName'); // Replace with actual ID if different
            const lastNameInput = document.getElementById('Input_LastName'); // Replace with actual ID if different
            const cityInput = document.getElementById('Input_City'); // Replace with actual ID if different
            const stateInput = document.getElementById('Input_State'); // Replace with actual ID if different

            function formatPhoneNumber(input) {
                const cleaned = ('' + input.value).replace(/\D/g, '');
                let formatted = '';
                if (cleaned.length > 0) {
                    formatted = '(' + cleaned.substring(0, 3);
                    if (cleaned.length > 3) {
                        formatted += ') ' + cleaned.substring(3, 6);
                    }
                    if (cleaned.length > 6) {
                        formatted += '-' + cleaned.substring(6, 10);
                    }
                }
                input.value = formatted;
            }

            if (phoneNumberInput) {
                phoneNumberInput.addEventListener('input', function () {
                    formatPhoneNumber(this);
                });
                phoneNumberInput.addEventListener('paste', function() {
                    setTimeout(() => formatPhoneNumber(this), 0);
                });
            }

            if (homephoneNumberInput) {
                homephoneNumberInput.addEventListener('input', function () {
                    formatPhoneNumber(this);
                });
                homephoneNumberInput.addEventListener('paste', function() {
                    setTimeout(() => formatPhoneNumber(this), 0);
                });
            }

            // Function to format a name (Title Case with exceptions)
            function formatName(name) {
                if (!name) return '';
                return name.toLowerCase().split(' ').map(word => {
                    if (word.startsWith('mc') && word.length > 2) {
                        return word.charAt(0).toUpperCase() + word.charAt(1).toLowerCase() + word.charAt(2).toUpperCase() + word.slice(3);
                    } else if (word.length > 0) {
                        return word.charAt(0).toUpperCase() + word.slice(1);
                    }
                    return '';
                }).join(' ');
            }

            // Add event listeners to format the name fields on input
            if (firstNameInput) {
                firstNameInput.addEventListener('input', function() {
                    this.value = formatName(this.value);
                });
            }

            if (middleNameInput) {
                middleNameInput.addEventListener('input', function() {
                    this.value = formatName(this.value);
                });
            }

            if (lastNameInput) {
                lastNameInput.addEventListener('input', function() {
                    this.value = formatName(this.value);
                });
            }

            if (cityInput) {
                cityInput.addEventListener('input', function() {
                    this.value = formatName(this.value);
                });
            }

            if (stateInput) {
                stateInput.addEventListener('input', function() {
                    this.value = this.value.substring(0, 2).toUpperCase();
                });
            }

            // Geolocation functionality
            const fillLocationBtn = document.getElementById('fillLocationBtn');
            if (fillLocationBtn) {
                fillLocationBtn.addEventListener('click', function() {
                    this.innerHTML = '‚è≥ Getting location...';
                    this.disabled = true;

                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(
                            function(position) {
                                // Use reverse geocoding to get city/state
                                const lat = position.coords.latitude;
                                const lon = position.coords.longitude;
                                
                                // Using nominatim (OpenStreetMap) for reverse geocoding - free API
                                fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&addressdetails=1`)
                                    .then(response => response.json())
                                    .then(data => {
                                        const address = data.address;
                                        if (address) {
                                            const cityField = document.getElementById('Input_City');
                                            const stateField = document.getElementById('Input_State');
                                            const zipField = document.getElementById('Input_ZipCode');
                                            
                                            if (cityField && address.city) {
                                                cityField.value = formatName(address.city);
                                            } else if (cityField && address.town) {
                                                cityField.value = formatName(address.town);
                                            } else if (cityField && address.municipality) {
                                                cityField.value = formatName(address.municipality);
                                            }
                                            
                                            if (stateField && address.state) {
                                                stateField.value = address.state_code || address.state.substring(0, 2).toUpperCase();
                                            }
                                            
                                            if (zipField && address.postcode) {
                                                zipField.value = address.postcode;
                                            }
                                        }
                                        fillLocationBtn.innerHTML = '‚úÖ Location filled!';
                                        setTimeout(() => {
                                            fillLocationBtn.innerHTML = 'üìç Use My Location';
                                            fillLocationBtn.disabled = false;
                                        }, 2000);
                                    })
                                    .catch(error => {
                                        console.error('Geocoding error:', error);
                                        fillLocationBtn.innerHTML = '‚ö†Ô∏è Location error';
                                        setTimeout(() => {
                                            fillLocationBtn.innerHTML = 'üìç Use My Location';
                                            fillLocationBtn.disabled = false;
                                        }, 2000);
                                    });
                            },
                            function(error) {
                                console.error('Geolocation error:', error);
                                fillLocationBtn.innerHTML = '‚ö†Ô∏è Location denied';
                                setTimeout(() => {
                                    fillLocationBtn.innerHTML = 'üìç Use My Location';
                                    fillLocationBtn.disabled = false;
                                }, 2000);
                            }
                        );
                    } else {
                        fillLocationBtn.innerHTML = '‚ö†Ô∏è Not supported';
                        setTimeout(() => {
                            fillLocationBtn.innerHTML = 'üìç Use My Location';
                            fillLocationBtn.disabled = false;
                        }, 2000);
                    }
                });
            }
        });
    </script>
}
